<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ECG Dinamico in JavaScript</title>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 20px; }
    canvas { border: 1px solid #444; margin-top: 20px; background: #f8f8f8; }
    .output { margin-top: 15px; font-size: 1.2em; }
  </style>
</head>
<body>
  <h1>Simulazione ECG Dinamica</h1>
  <canvas id="ecg-canvas" width="1000" height="300"></canvas>
  <div class="output" id="output"></div>

  <script>
    const canvas = document.getElementById("ecg-canvas");
    const ctx = canvas.getContext("2d");
    const W = canvas.width;
    const H = canvas.height;

    const fs = 250;  // Frequenza di campionamento
    const bufferSize = fs * 5; // 5 secondi di dati nel buffer
    let ecgBuffer = Array(bufferSize).fill(0);
    let peaks = [];
    let time = 0;

    // Simula valore ECG a tempo t
    function simulateECG(t) {
      let signal = 0.6 * Math.sin(2 * Math.PI * 1 * t); // onda base
      signal += 0.05 * (Math.random() * 2 - 1);          // rumore
      if (Math.floor(t) !== Math.floor(t - 1 / fs)) {
        // ogni 1s circa, aggiungi picco
        signal += 1.5;
      }
      return signal;
    }

    function update() {
      const newValue = simulateECG(time);
      time += 1 / fs;

      // aggiorna buffer (FIFO)
      ecgBuffer.push(newValue);
      if (ecgBuffer.length > bufferSize) ecgBuffer.shift();

      // rileva picchi
      if (ecgBuffer.length >= 3) {
        const i = ecgBuffer.length - 2;
        if (
          ecgBuffer[i] > 1.0 &&
          ecgBuffer[i] > ecgBuffer[i - 1] &&
          ecgBuffer[i] > ecgBuffer[i + 1]
        ) {
          const lastPeak = peaks.length > 0 ? peaks[peaks.length - 1] : -Infinity;
          if (i - lastPeak > fs * 0.5) {
            peaks.push(i);
            if (peaks.length > 10) peaks.shift();
          }
        }
      }

      // calcola BPM
      let bpm = 0;
      if (peaks.length >= 2) {
        let rr = [];
        for (let i = 1; i < peaks.length; i++) {
          rr.push((peaks[i] - peaks[i - 1]) / fs);
        }
        const rrAvg = rr.reduce((a, b) => a + b, 0) / rr.length;
        bpm = 60 / rrAvg;
      }

      document.getElementById("output").innerHTML =
        `Frequenza cardiaca stimata: <strong>${bpm.toFixed(2)} BPM</strong>`;

      drawGraph();
    }

    function drawGraph() {
      ctx.clearRect(0, 0, W, H);
      const min = Math.min(...ecgBuffer);
      const max = Math.max(...ecgBuffer);

      ctx.beginPath();
      for (let i = 0; i < ecgBuffer.length; i++) {
        const x = (i / ecgBuffer.length) * W;
        const y = H - ((ecgBuffer[i] - min) / (max - min)) * H;
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      }
      ctx.strokeStyle = "blue";
      ctx.lineWidth = 1;
      ctx.stroke();

      // disegna i picchi R
      ctx.fillStyle = "red";
      peaks.forEach(p => {
        const x = (p / ecgBuffer.length) * W;
        const y = H - ((ecgBuffer[p] - min) / (max - min)) * H;
        ctx.beginPath();
        ctx.arc(x, y, 3, 0, 2 * Math.PI);
        ctx.fill();
      });
    }

    setInterval(update, 1000 / fs); // aggiorna a 250 Hz
  </script>
</body>
</html>
